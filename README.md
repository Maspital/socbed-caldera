# CALDERA-plugin for SOCBED

This plugin is intended to extend the functionality of the [SOCBED framework](https://github.com/fkie-cad/socbed) by enabling the user to execute the attack chain presented in [MITREs APT29 Attack Evaluation](https://attackevals.mitre-engenuity.org/enterprise/apt29/).
To achieve this, [CALDERA](https://github.com/mitre/caldera) is installed on the Attacker-VM and provided all necessary information - abilities, techniques and payloads.

## Installation

**WARNING**: The payloads used by APT29 contain several potentially malicous files.
Due to some problems with ansible, these are not yet encrypted, so be aware that your anti-virus software of choice might sound the alarm.


This plugin is intended to be used with SOCBED v1.1.3.
Using another version may or may not have unintended side effects.
```sh
# Clone this repository
git clone git@github.com:Maspital/socbed-caldera.git

# Run the installation script, providing the path to your socbed directory
./socbed-caldera/install_plugin /socbed/directory/
```

## Usage

The execution of the APT29 attack chain is fully automated and can be accessed via the `attackconsole`.
```sh
# Activate the virtual environment you created when installing SOCBED
source ~/.virtualenvs/socbed/bin/activate

# Start the virtual machines
vmconsole -c start_session

# WAIT at least 10 minutes before the next step
# Start the attackconsole and run the "caldera_evaluation" attack
attackconsole
attackconsole > use caldera_evaluation
attackconsole > run
```
This attack will take up to 30 minutes.
Afterwards, the logs collected by the Log Server will be automatically extracted to the path defined in the attack options, resulting in two log files, `winlogbeat.jsonl` and `syslog.jsonl`.
The former is then checked for certain success indicators for each attack, followed by a summary of the entire attack chain.

You can monitor the attack process in greater detail by using CALDERA's web-interface, which you can access via http://192.168.56.31:8888/ (login: breach/breach). This is also the place where you can manually execute attacks or modify parts of them; for more information refere to [CALDERA's documentation](https://caldera.readthedocs.io/en/3.0.0/).

If you want to evaluate previously created log files again, you can do so using the script provided in `src/attacks/caldera_tools/caldera_eval_standalone.py`.
```sh
cd src/attacks/caldera_tools
python3 caldera_eval_standalone.py -h

usage: caldera_eval_standalone.py [-h] [-v] [-t] jsonl_log_file search_strings_dir

This script evaluates the success of CALDERA during a SOCBED simulation.

positional arguments:
  jsonl_log_file      .jsonl file generated by a SOCBED simulation
  search_strings_dir  path to directory containing the layer1/layer2 strings for each ability

optional arguments:
  -h, --help          show this help message and exit
  -v, --verbose       increase output verbosity
  -t, --times         show individual runtime of each ability
```
Example:
```sh
python3 caldera_eval_standalone.py /tmp/winlogbeat_foo.jsonl search_strings/
```

## Options

Within the attackconsole, you can modify certain options of the `caldera_evaluation` attack:
```sh
attackconsole
attackconsole > use caldera_evaluation
attackconsole > options

Attack Options
==================

+--------------+----------------------+-------------------------------------------------------+
|     Name     |   Current Setting    |                      Description                      |
+--------------+----------------------+-------------------------------------------------------+
| caldera_host | http://192.168.56.31 |   Host address of the machine CALDERA is running on   |
| caldera_port |         8888         |              Port CALDERA is listening on             |
|  keep_logs   |        False         | Whether or not to delete created log files afterwards |
|   log_dir    |         /tmp         |      Where to save created log files (full path)      |
|  log_suffix  |         foo          |       Suffix to be appended to created log files      |
+--------------+----------------------+-------------------------------------------------------+
```
It is not recommended to change the first two options, `caldera_host` and `caldera_port`, unless you know what you are doing.
Change the other options as you see fit, for example:
```sh
attackconsole > set keep_logs True
attackconsole > set log_dir /some/other/dir
attackconsole > set log_suffix test_42
```
